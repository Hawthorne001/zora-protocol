# `CoinV4.sol`

The `CoinV4` contract is the core contract for the Zora Coins Protocol. It is a non-upgradeable ERC20 contract built on Uniswap V4 that allows for the creation of media coins with advanced hook-based functionality.

## Overview

The `CoinV4` contract implements multiple interfaces:
- `ICoinV4`: Core V4 coin functionality
- `IHasPoolKey`: Provides access to the Uniswap V4 pool key
- `IHasSwapPath`: Enables complex multi-hop reward distribution
- `IERC165`: Standard interface detection
- `IERC721Receiver`: Enables receiving ERC721 tokens (for LP tokens)
- `IERC7572`: Standard for protocol-specific metadata

Each coin is created with a Uniswap V4 liquidity pool and an advanced hook system that automatically handles fee collection and reward distribution.

## Key Features

- **ERC20 Functionality**: Basic token transfers, approvals, and balance tracking
- **Uniswap V4 Integration**: Built-in hooks for advanced pool management and automatic fee processing
- **Automatic Reward Distribution**: Hooks that collect LP fees, swap them to backing currency, and distribute rewards on every trade
- **Multi-Hop Fee Conversion**: Supports complex swap paths for coins paired with other coins
- **Advanced Pool Configuration**: Support for multiple liquidity positions and sophisticated market curves
- **Metadata Management**: Updatable contract metadata via URI
- **Multi-Ownership**: Support for multiple owners with permission control

## Hook System

The `CoinV4` contract uses the `ZoraV4CoinHook` which automatically executes on every swap to handle reward distribution. The hook performs three key operations:

### 1. Collect LP Fees
On every swap, the hook collects accrued fees from all liquidity positions in the pool. These fees are generated from trading activity and accumulate over time.

### 2. Swap LP Fees to Backing Currency
The collected fees are automatically swapped to the backing currency through optimal swap paths. For example:
- If a coin is paired directly with USDC, fees are swapped directly to USDC
- If a coin is paired with another coin (like a backing coin), the fees follow the swap path: `ContentCoin → BackingCoin → USDC`

### 3. Distribute Rewards
The final backing currency is then distributed to reward recipients:
- **Creator**: 50% to the payout recipient
- **Create Referral**: 15% to the platform that referred the creator
- **Trade Referral**: 15% to the platform that referred this specific trade
- **Protocol**: 15% to the ZORA protocol treasury
- **Doppler**: 5% to the governance entity

All of this happens automatically in a single transaction whenever someone trades the coin.

## Core Functions

### Pool and Configuration

#### getPoolKey

```solidity
function getPoolKey() external view returns (PoolKey memory);
```

Returns the Uniswap V4 pool key associated with this coin, containing pool identification parameters including currencies, fee tier, tick spacing, and hooks.

#### getPoolConfiguration

```solidity
function getPoolConfiguration() external view returns (PoolConfiguration memory);
```

Returns the pool configuration settings including fee structure, tick spacing, number of positions, and liquidity curve parameters.

#### hooks

```solidity
function hooks() external view returns (IHooks);
```

Returns the hooks contract (ZoraV4CoinHook) that handles pool lifecycle events like swaps and automatic reward distribution.

### Swap Path for Multi-Hop Rewards

#### getPayoutSwapPath

```solidity
function getPayoutSwapPath(IDeployedCoinVersionLookup coinVersionLookup) external view returns (PayoutSwapPath memory);
```

Returns the swap path configuration for converting this coin's fees to its final payout currency. This enables multi-hop swaps through intermediate currencies.

The `PayoutSwapPath` struct contains:
- `currencyIn`: The input currency (this coin)
- `path`: Array of swap steps to reach the final payout currency

Example for a content coin paired with a backing coin:
1. Content coin → Backing coin (first hop)
2. Backing coin → USDC (second hop)

### Trading Functions

#### buy

```solidity
function buy(
    address recipient,
    uint256 orderSize,
    uint256 minAmountOut,
    uint160 sqrtPriceLimitX96,
    address tradeReferrer
) external payable returns (uint256, uint256);
```

Allows users to buy coins using ETH or the configured trading currency. The buyer sends currency and receives newly minted coins.

Parameters:
- `recipient`: Address that will receive the purchased coins
- `orderSize`: Amount of currency to spend (in wei)
- `minAmountOut`: Minimum amount of coins to receive (slippage protection)
- `sqrtPriceLimitX96`: Price limit for the swap (0 for no limit)
- `tradeReferrer`: Address that receives a portion of the trading fee (optional)

#### sell

```solidity
function sell(
    address recipient,
    uint256 orderSize,
    uint256 minAmountOut,
    uint160 sqrtPriceLimitX96,
    address tradeReferrer
) external returns (uint256, uint256);
```

Allows users to sell their coins in exchange for the trading currency. Coins are burned during the sale.

Parameters:
- `recipient`: Address that will receive the currency proceeds
- `orderSize`: Amount of coins to sell
- `minAmountOut`: Minimum amount of currency to receive (slippage protection)
- `sqrtPriceLimitX96`: Price limit for the swap (0 for no limit)
- `tradeReferrer`: Address that receives a portion of the trading fee (optional)

#### burn

```solidity
function burn(uint256 amount) external;
```

Allows users to burn their own tokens, permanently removing them from circulation.

### Management Functions

#### setContractURI

```solidity
function setContractURI(string memory newURI) external onlyOwner;
```

Updates the coin's metadata URI. This can only be called by an owner of the coin.

#### setPayoutRecipient

```solidity
function setPayoutRecipient(address newPayoutRecipient) external onlyOwner;
```

Updates the address that receives creator rewards. This can only be called by an owner of the coin.

### Query Functions

```solidity
function tokenURI() external view returns (string memory);
function platformReferrer() external view returns (address);
function currency() external view returns (address);
```

These functions provide access to key coin information:
- `tokenURI`: Returns the coin's metadata URI
- `platformReferrer`: Returns the address of the platform referrer who earns fees from trades
- `currency`: Returns the address of the backing currency this coin is paired with

## Events

### Hook Events

#### Swapped

```solidity
event Swapped(
    address indexed sender,
    address indexed swapSender,
    bool isTrustedSwapSenderAddress,
    PoolKey key,
    bytes32 indexed poolKeyHash,
    SwapParams params,
    int128 amount0,
    int128 amount1,
    bool isCoinBuy,
    bytes hookData,
    uint160 sqrtPriceX96
);
```

Emitted by the hook when a swap occurs, providing detailed information about the transaction including price data and swap direction.

#### CoinMarketRewardsV4

```solidity
event CoinMarketRewardsV4(
    address indexed coin,
    address indexed currency,
    address indexed payoutRecipient,
    address platformReferrer,
    address tradeReferrer,
    address protocolRewardRecipient,
    address dopplerRecipient,
    MarketRewardsV4 marketRewards
);
```

Emitted when market rewards are distributed, showing exactly how much each recipient received in the backing currency.

### Coin Events

#### CoinBuy

```solidity
event CoinBuy(
    address indexed buyer,
    address indexed recipient,
    address indexed tradeReferrer,
    uint256 coinsPurchased,
    address currency,
    uint256 amountFee,
    uint256 amountSold
);
```

Emitted when coins are purchased, tracking the buyer, recipient, trade referrer, amount of coins purchased, currency used, fees paid, and total amount spent.

#### CoinSell

```solidity
event CoinSell(
    address indexed seller,
    address indexed recipient,
    address indexed tradeReferrer,
    uint256 coinsSold,
    address currency,
    uint256 amountFee,
    uint256 amountPurchased
);
```

Emitted when coins are sold, tracking the seller, recipient, trade referrer, amount of coins sold, currency received, fees paid, and total amount received.

#### CoinTransfer

```solidity
event CoinTransfer(
    address indexed sender,
    address indexed recipient,
    uint256 amount,
    uint256 senderBalance,
    uint256 recipientBalance
);
```

Emitted on any token transfer, providing detailed information about the transfer including updated balances.

#### ContractMetadataUpdated

```solidity
event ContractMetadataUpdated(
    address indexed caller,
    string newURI,
    string name
);
```

Emitted when the contract metadata URI is updated.

#### CoinPayoutRecipientUpdated

```solidity
event CoinPayoutRecipientUpdated(
    address indexed caller,
    address indexed prevRecipient,
    address indexed newRecipient
);
```

Emitted when the payout recipient is updated.

## Error Handling

The contract defines several custom errors that provide specific information about failed operations:

### Common Errors

- `AddressZero`: Operation attempted with a zero address
- `InsufficientFunds`: Insufficient funds for the operation
- `InsufficientLiquidity`: Insufficient liquidity for a transaction
- `SlippageBoundsExceeded`: Slippage bounds exceeded during a transaction
- `InitialOrderSizeTooLarge`: Initial order size too large
- `EthAmountMismatch`: ETH value doesn't match the currency amount
- `EthAmountTooSmall`: ETH amount too small for the transaction
- `ERC20TransferAmountMismatch`: Unexpected ERC20 transfer amount
- `EthTransferInvalid`: Invalid ETH transfer
- `EthTransferFailed`: ETH transfer failed

### Hook-Specific Errors

- `NotACoin`: Non-coin contract attempted to use V4 hook
- `NoCoinForHook`: Pool not properly initialized for hook
- `PathMustHaveAtLeastOneStep`: Invalid swap path configuration for multi-hop rewards
- `CoinVersionLookupCannotBeZeroAddress`: Version lookup contract cannot be zero address
